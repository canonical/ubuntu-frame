#!/bin/sh
set -eux
if [ "$1" = "--help" ]; then set +x; fi

XDG_RUNTIME_DIR=$(dirname "$XDG_RUNTIME_DIR")
export XDG_RUNTIME_DIR
mkdir -p "$XDG_RUNTIME_DIR" -m 700

# If there's an existing Wayland server, we're likely on a Wayland desktop
if [ -n "${WAYLAND_DISPLAY:-}" ] && [ -e "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]
then
  # Allow Mir to select an uncontested WAYLAND_DISPLAY
  unset WAYLAND_DISPLAY
fi

format='{"datetime": "%s", "appid": "ubuntu-frame, "event": "%s", "level": "WARN", "description": "%s" }'

printf "$format\n" "$( date --universal +%FT%TZ  )" "sys_startup" "Ubuntu Frame is starting up"

"$@"
RC=$?

if [ $RC -ne 0 ]; then
  printf "$format\n" "$( date --universal +%FT%TZ  )" "sys_crash" "Ubuntu Frame exited unexpectedly"
  exit $RC
fi
printf "$format\n" "$( date --universal +%FT%TZ  )" "sys_shutdown" "Ubuntu Frame is shutting down"
